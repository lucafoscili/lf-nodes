name: Update Node Count

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  count-nodes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Count Node Python Files
        id: count
        run: |
          set -e
          # Count every Python file under modules/nodes (recursively) excluding __init__.py and tests directories/files
          COUNT=$(find modules/nodes -type f -name '*.py' \
            ! -name '__init__.py' \
            ! -path '*/tests/*' \
            ! -path '*/test_*' | wc -l)

          echo "Discovered $COUNT node files"
          echo "nodes=$COUNT" >> $GITHUB_OUTPUT
          echo "{ \"nodes\": $COUNT }" > count.json

      - name: (Optional) Verify Count with Python
        run: |
          python - <<'PY'
          import json, pathlib
          root = pathlib.Path('modules/nodes')
          files = [p for p in root.rglob('*.py') if p.name != '__init__.py' and 'tests' not in p.parts and not p.name.startswith('test_')]
          print(f"Python verification count: {len(files)}")
          # Ensure consistency with existing count.json
          with open('count.json') as f:
              current = json.load(f).get('nodes')
          if current != len(files):
              raise SystemExit(f"Mismatch between shell count ({current}) and python count ({len(files)})")
          PY

      - name: Create Pull Request with Node Count Update
        if: github.event_name == 'push'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'ðŸ¤– Auto-update node count: ${{ steps.count.outputs.nodes }} files'
          title: 'ðŸ”¢ Update node count to ${{ steps.count.outputs.nodes }}'
          body: |
            This PR automatically updates the node count based on the number of Python node files (excluding __init__.py and tests) in modules/nodes.
          branch: 'update-node-count/${{ github.run_id }}-${{ github.sha }}'
          # Labels are intentionally omitted to avoid potential permission issues.
          author: 'github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>'
          add-paths: 'count.json'

      - name: Comment Node Count on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ðŸ”¢ Node file count: **${{ steps.count.outputs.nodes }}**
            (Excludes __init__.py and tests)
